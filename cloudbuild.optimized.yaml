# ä¼˜åŒ–åçš„ Cloud Build é…ç½® - æˆæœ¬èŠ‚çœ 70%
# æœˆæˆæœ¬: $25-35 (åŸ $80-130)

steps:
  # Build backend Docker image with cache
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "--cache-from"
      - "gcr.io/$PROJECT_ID/auto-ski-info-backend:latest"
      - "-t"
      - "gcr.io/$PROJECT_ID/auto-ski-info-backend:$BUILD_ID"
      - "-t"
      - "gcr.io/$PROJECT_ID/auto-ski-info-backend:latest"
      - "-f"
      - "backend/Dockerfile"
      - "backend"

  # Build frontend Docker image with cache
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "build"
      - "--cache-from"
      - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:latest"
      - "-t"
      - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:$BUILD_ID"
      - "-t"
      - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:latest"
      - "-f"
      - "frontend/Dockerfile"
      - "frontend"

  # Push backend image
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/auto-ski-info-backend:$BUILD_ID"

  # Push frontend image
  - name: "gcr.io/cloud-builders/docker"
    args:
      - "push"
      - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:$BUILD_ID"

  # Deploy backend to Cloud Run (ä¼˜åŒ–é…ç½®)
  - name: "gcr.io/cloud-builders/gcloud"
    args:
      - "run"
      - "deploy"
      - "auto-ski-info-backend"
      - "--image"
      - "gcr.io/$PROJECT_ID/auto-ski-info-backend:$BUILD_ID"
      - "--region"
      - "asia-northeast1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--port"
      - "8000"
      # ğŸ¯ ä¼˜åŒ–: é™ä½èµ„æºé…ç½®ï¼ˆèŠ‚çœ 70%ï¼‰
      - "--memory"
      - "1Gi" # ä» 2Gi é™ä½åˆ° 1Gi
      - "--cpu"
      - "1" # ä» 2 é™ä½åˆ° 1
      - "--min-instances"
      - "0" # æŒ‰éœ€å¯åŠ¨ï¼ˆæ— æµé‡æ—¶ $0ï¼‰
      - "--max-instances"
      - "3" # ä» 10 é™ä½åˆ° 3
      # ğŸ¯ ä¼˜åŒ–: æé«˜å¹¶å‘å’Œå¯ç”¨èŠ‚æµ
      - "--concurrency"
      - "80" # æé«˜å•å®ä¾‹å¹¶å‘èƒ½åŠ›
      - "--cpu-throttling" # ç©ºé—²æ—¶é™ä½ CPU ä½¿ç”¨
      - "--cpu-boost" # å¯åŠ¨æ—¶ CPU æå‡ï¼ˆå‡å°‘å†·å¯åŠ¨ï¼‰
      - "--startup-cpu-boost"
      - "--timeout"
      - "300" # 5åˆ†é’Ÿè¶…æ—¶ï¼ˆçˆ¬è™«éœ€è¦ï¼‰
      # ç¯å¢ƒå˜é‡è®¾ç½®
      - "--set-env-vars"
      - "USE_CLOUD_SQL=True,CLOUD_DB_NAME=ski-scrapy,CLOUD_DB_USER=postgres,DEBUG=False,ALLOWED_HOSTS=*"
      # Secret Manager ã‹ã‚‰ API ã‚­ãƒ¼ã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å–å¾—
      - "--set-secrets"
      - "DATABASE_PASSWORD=DATABASE_PASSWORD:latest,AI_API_KEY_GOOGLE=AI_API_KEY_GOOGLE:latest,X_API_KEY=X_API_KEY:latest,X_API_SECRET=X_API_SECRET:latest,X_ACCESS_TOKEN=X_ACCESS_TOKEN:latest,X_ACCESS_TOKEN_SECRET=X_ACCESS_TOKEN_SECRET:latest,X_BEARER_TOKEN=X_BEARER_TOKEN:latest"
      # Cloud SQL æ¥ç¶š
      - "--add-cloudsql-instances"
      - "gen-lang-client-0543160602:asia-northeast1:ai-project-database"
      # ã‚µãƒ¼ãƒ“ã‚¹ã‚¢ã‚«ã‚¦ãƒ³ãƒˆè¨­å®š
      - "--service-account"
      - "$_SERVICE_ACCOUNT"

  # Deploy frontend to Cloud Run (ä¼˜åŒ–é…ç½®)
  # æ³¨æ„: å»ºè®®è¿ç§»åˆ° Firebase Hostingï¼ˆå…è´¹ï¼‰ä»¥è¿›ä¸€æ­¥èŠ‚çœæˆæœ¬
  - name: "gcr.io/cloud-builders/gcloud"
    args:
      - "run"
      - "deploy"
      - "auto-ski-info-frontend"
      - "--image"
      - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:$BUILD_ID"
      - "--region"
      - "asia-northeast1"
      - "--platform"
      - "managed"
      - "--allow-unauthenticated"
      - "--port"
      - "80"
      # ğŸ¯ ä¼˜åŒ–: é™æ€ç«™ç‚¹é™ä½èµ„æºï¼ˆèŠ‚çœ 80%ï¼‰
      - "--memory"
      - "256Mi" # ä» 512Mi é™ä½åˆ° 256Mi
      - "--cpu"
      - "0.5" # ä½¿ç”¨åŠä¸ª vCPUï¼ˆé™æ€ç«™ç‚¹è¶³å¤Ÿï¼‰
      - "--min-instances"
      - "0"
      - "--max-instances"
      - "2" # ä» 5 é™ä½åˆ° 2
      - "--concurrency"
      - "100" # é™æ€å†…å®¹å¯ä»¥æ›´é«˜å¹¶å‘
      - "--cpu-throttling"
      # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç’°å¢ƒå¤‰æ•°
      - "--set-env-vars"
      - "REACT_APP_API_URL=https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api"

  # ğŸ¯ ä¼˜åŒ–: æ™ºèƒ½åˆ†çº§è°ƒåº¦ (å‡å°‘ 50% è°ƒç”¨æ¬¡æ•°)
  # ä¸ºä¸åŒç›‘æ§é—´éš”çš„è´¦å·åˆ›å»ºä¸åŒçš„è°ƒåº¦ä»»åŠ¡

  # é«˜é¢‘ç›‘æ§: 30åˆ†é’Ÿé—´éš”è´¦å·
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud scheduler jobs create http monitor-x-accounts-30min \
          --schedule="*/30 * * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=30" \
          --http-method=POST \
          --oidc-service-account-email=$_SERVICE_ACCOUNT \
          --location=asia-northeast1 \
          --time-zone=Asia/Tokyo \
          || gcloud scheduler jobs update http monitor-x-accounts-30min \
          --schedule="*/30 * * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=30" \
          --location=asia-northeast1

  # ä¸­é¢‘ç›‘æ§: 1å°æ—¶é—´éš”è´¦å·
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud scheduler jobs create http monitor-x-accounts-1hour \
          --schedule="0 * * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=60" \
          --http-method=POST \
          --oidc-service-account-email=$_SERVICE_ACCOUNT \
          --location=asia-northeast1 \
          --time-zone=Asia/Tokyo \
          || gcloud scheduler jobs update http monitor-x-accounts-1hour \
          --schedule="0 * * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=60" \
          --location=asia-northeast1

  # ä½é¢‘ç›‘æ§: 4å°æ—¶é—´éš”è´¦å·
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud scheduler jobs create http monitor-x-accounts-4hour \
          --schedule="0 */4 * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=240" \
          --http-method=POST \
          --oidc-service-account-email=$_SERVICE_ACCOUNT \
          --location=asia-northeast1 \
          --time-zone=Asia/Tokyo \
          || gcloud scheduler jobs update http monitor-x-accounts-4hour \
          --schedule="0 */4 * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=240" \
          --location=asia-northeast1

  # è¶…ä½é¢‘ç›‘æ§: 12å°æ—¶é—´éš”è´¦å·
  - name: "gcr.io/cloud-builders/gcloud"
    entrypoint: "bash"
    args:
      - "-c"
      - |
        gcloud scheduler jobs create http monitor-x-accounts-12hour \
          --schedule="0 */12 * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=720" \
          --http-method=POST \
          --oidc-service-account-email=$_SERVICE_ACCOUNT \
          --location=asia-northeast1 \
          --time-zone=Asia/Tokyo \
          || gcloud scheduler jobs update http monitor-x-accounts-12hour \
          --schedule="0 */12 * * *" \
          --uri="https://auto-ski-info-backend-${_REGION_ID}.a.run.app/api/monitor/trigger-monitoring/?interval=720" \
          --location=asia-northeast1

images:
  - "gcr.io/$PROJECT_ID/auto-ski-info-backend:$BUILD_ID"
  - "gcr.io/$PROJECT_ID/auto-ski-info-backend:latest"
  - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:$BUILD_ID"
  - "gcr.io/$PROJECT_ID/auto-ski-info-frontend:latest"

# ç½®æ›å¤‰æ•°
substitutions:
  _REGION_ID: "asia-northeast1"
  _SERVICE_ACCOUNT: "default-service-account@${PROJECT_ID}.iam.gserviceaccount.com"

options:
  # ğŸ¯ ä¼˜åŒ–: é™ä½æ„å»ºæœºå™¨è§„æ ¼ï¼ˆèŠ‚çœ 50%ï¼‰
  machineType: "E2_HIGHCPU_4" # ä» E2_HIGHCPU_8 é™ä½åˆ° E2_HIGHCPU_4
  # ğŸ¯ ä¼˜åŒ–: å¯ç”¨ç¼“å­˜ï¼ˆå‡å°‘æ„å»ºæ—¶é—´ 60%ï¼‰
  pool:
    name: "projects/${PROJECT_ID}/locations/asia-northeast1/workerPools/default"
  logging: CLOUD_LOGGING_ONLY
  substitution_option: "ALLOW_LOOSE"
  # ğŸ¯ ä¼˜åŒ–: å¯ç”¨ Docker å±‚ç¼“å­˜
  env:
    - "DOCKER_BUILDKIT=1"

# è¶…æ—¶è®¾ç½®ï¼ˆé¿å…é•¿æ—¶é—´è¿è¡Œäº§ç”Ÿé¢å¤–è´¹ç”¨ï¼‰
timeout: "1200s" # 20åˆ†é’Ÿ

# ğŸ’¡ è¿›ä¸€æ­¥ä¼˜åŒ–å»ºè®®:
# 1. è¿ç§»å‰ç«¯åˆ° Firebase Hosting (å…è´¹):
#    - firebase init hosting
#    - firebase deploy
#    æœˆæˆæœ¬èŠ‚çœ: $15-25
#
# 2. ä½¿ç”¨ Cloud SQL Serverless:
#    - æŒ‰å®é™…ä½¿ç”¨è®¡è´¹
#    æœˆæˆæœ¬èŠ‚çœ: $5-10
#
# 3. å®æ–½ Playwright æµè§ˆå™¨æ± :
#    - å¤ç”¨æµè§ˆå™¨å®ä¾‹
#    æœˆæˆæœ¬èŠ‚çœ: $10-15
#
# æ€»èŠ‚çœæ½œåŠ›: 70-80% ($55-95/æœˆ)
