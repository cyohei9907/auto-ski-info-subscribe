# 监控计划安排功能 - 快速开始

## 功能特点

✅ **灵活的监控间隔** - 每个账户可独立设置监控频率  
✅ **智能调度系统** - 根据上次检查时间自动判断是否需要监控  
✅ **资源优化** - 避免不必要的请求，降低被限流的风险  
✅ **实时调整** - 前端直接修改，无需重启服务

## 快速使用

### 1. 在前端设置监控间隔

1. 打开浏览器访问：`http://localhost:3000`
2. 登录后进入"アカウント管理"页面
3. 在账户列表中找到"監視間隔"列
4. 点击下拉菜单选择合适的间隔：
   - **30 分ごと** - 每 30 分钟
   - **1 時間ごと** - 每 1 小时
   - **4 時間ごと** - 每 4 小时（推荐默认）
   - **12 時間ごと** - 每 12 小时

### 2. 查看监控状态

在"ステータス"列可以看到：

- 🟢 **監視中** - 账户正在监控
- 🔴 **停止中** - 账户已停止
- ⏰ **最終: HH:MM** - 最后检查时间

### 3. 手动触发监控

如果不想等待自动调度，可以点击：

- 👁️ **今すぐ監視** - 立即检查该账户
- 🔄 **当日全て** - 获取 24 小时内的所有推文

## 监控间隔建议

| 账户类型           | 推荐间隔 | 说明                     |
| ------------------ | -------- | ------------------------ |
| 新闻媒体、突发事件 | 30 分钟  | 需要及时获取信息         |
| 活跃的商业账户     | 1 小时   | 保持较高的更新频率       |
| 普通关注账户       | 4 小时   | 平衡性能和及时性 ⭐ 推荐 |
| 不活跃账户         | 12 小时  | 降低资源消耗             |

## 系统架构

```
┌─────────────────────────────────────────────────────┐
│         Celery Beat (每30分钟触发一次)                │
└─────────────────────┬───────────────────────────────┘
                      │
                      ▼
┌─────────────────────────────────────────────────────┐
│      monitor_all_active_accounts 任务                │
│                                                       │
│  遍历所有激活账户，检查是否到了监控时间：              │
│  • 如果 last_checked 为空 → 立即监控                 │
│  • 如果 距离上次检查 >= monitoring_interval → 监控   │
│  • 否则 → 跳过本次                                   │
└─────────────────────┬───────────────────────────────┘
                      │
        ┌─────────────┼─────────────┐
        ▼             ▼             ▼
    Account A     Account B     Account C
    (30分钟)      (4小时)       (12小时)
```

## 技术实现

### 数据库字段

```python
monitoring_interval = models.IntegerField(
    choices=[
        (30, '每30分钟'),
        (60, '每1小时'),
        (240, '每4小时'),
        (720, '每12小时'),
    ],
    default=240
)
```

### 智能调度逻辑

```python
now = timezone.now()
if account.last_checked is None:
    should_monitor = True
else:
    time_since_last_check = (now - account.last_checked).total_seconds() / 60
    if time_since_last_check >= account.monitoring_interval:
        should_monitor = True
```

### API 响应示例

```json
{
  "data": [
    {
      "id": 1,
      "username": "skiinfomation",
      "monitoring_interval": 240,
      "monitoring_interval_display": "每4小时",
      "is_active": true,
      "last_checked": "2025-11-09T04:30:00Z"
    }
  ]
}
```

## 常见问题

### Q: 修改间隔后多久生效？

A: 数据库立即更新，但需要等待下一次 Beat 任务运行（最多 30 分钟）。可以手动点击"今すぐ監視"立即触发。

### Q: 所有账户都应该用最短间隔吗？

A: 不建议。频繁请求可能触发 X.com 的限流机制。建议根据账户重要性合理分配。

### Q: 如何查看监控历史？

A: 进入"監視ログ"页面，可以看到所有监控记录，包括成功/失败状态和执行时间。

### Q: 停止的账户还会被监控吗？

A: 不会。只有 `is_active=True` 的账户才会被监控。点击"停止"按钮即可暂停监控。

## 测试验证

运行单元测试：

```bash
cd backend
python manage.py test test_monitoring_interval
```

预期输出：

```
Found 5 test(s).
.....
Ran 5 tests in 1.403s
OK
```

## 性能优化建议

1. **分散监控时间**

   - 不要让所有账户在同一时间监控
   - 系统会自动根据 `last_checked` 分散执行

2. **合理设置间隔**

   - 大部分账户使用 4 小时 或 12 小时
   - 只对重要账户使用 30 分钟

3. **定期清理**
   - 删除不再关注的账户
   - 停止不活跃的账户监控

## 下一步计划

- [ ] 添加自定义间隔（输入任意分钟数）
- [ ] 根据账户活跃度自动调整间隔
- [ ] 支持不同时段使用不同间隔
- [ ] 监控统计和分析面板

## 相关文档

- [完整技术文档](./MONITORING_SCHEDULE.md)
- [部署说明](./DEPLOY.md)
- [配置说明](./CONFIGURATION.md)

---

**版本**: 1.0  
**更新日期**: 2025-11-09  
**作者**: Auto Ski Info Subscribe Team
